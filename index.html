<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TitanGraph v4 | Civic Intelligence Platform</title>
    
    <!-- Dependencies -->
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three-spritetext"></script>
    <script src="//unpkg.com/force-graph"></script>
    <script src="//unpkg.com/3d-force-graph"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f111a;
            --panel-bg: #1a1d29;
            --border: #2f3542;
            --accent: #00d2d3;
            --accent-dim: rgba(0, 210, 211, 0.1);
            --text-main: #dfe6e9;
            --text-muted: #b2bec3;
            --danger: #ff6b6b;
            --success: #1dd1a1;
            --warning: #feca57;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); color: var(--text-main); font-family: var(--font-ui); }

        /* --- LAYOUT --- */
        #app-container {
            display: grid;
            grid-template-columns: 60px 1fr 300px;
            grid-template-rows: 50px 1fr auto; /* Auto for log panel */
            height: 100vh; width: 100vw;
        }

        /* --- HEADER --- */
        header {
            grid-column: 1 / -1; background: var(--panel-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10;
        }
        .brand { font-family: var(--font-mono); font-weight: 700; color: var(--accent); letter-spacing: 1px; display: flex; gap: 10px; align-items: center; }
        .header-controls { display: flex; gap: 10px; }

        /* --- TOOLBAR --- */
        #toolbar {
            grid-row: 2; background: var(--panel-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; gap: 10px; z-index: 5;
        }
        .tool-btn {
            width: 40px; height: 40px; border-radius: 6px; border: 1px solid transparent;
            background: transparent; color: var(--text-muted); cursor: pointer; transition: 0.2s;
            display: grid; place-items: center; font-size: 1.1rem;
        }
        .tool-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .tool-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        /* --- VIEWPORT --- */
        #viewport {
            grid-column: 2; grid-row: 2; position: relative; overflow: hidden;
            background: radial-gradient(circle at center, #1e2330 0%, #0f111a 100%);
        }
        #graph-canvas { width: 100%; height: 100%; }

        /* --- INSPECTOR --- */
        #inspector {
            grid-column: 3; grid-row: 2; background: var(--panel-bg); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-head { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); }
        .panel-body { padding: 15px; overflow-y: auto; flex: 1; }

        /* --- LOG CONSOLE --- */
        #log-panel {
            grid-column: 1 / -1; grid-row: 3;
            background: #000; border-top: 1px solid var(--accent);
            display: flex; flex-direction: column;
            transition: height 0.3s ease;
            height: 150px; /* Default open height */
            z-index: 20;
        }
        #log-panel.minimized { height: 35px; }
        
        .log-header {
            height: 35px; background: var(--panel-bg); display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; font-family: var(--font-mono); font-size: 0.8rem; border-bottom: 1px solid #333;
        }
        .log-controls { display: flex; gap: 10px; }
        .log-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }
        .log-btn:hover { color: var(--text-main); border-color: var(--text-main); }
        
        #log-content {
            flex: 1; overflow-y: auto; padding: 10px; font-family: var(--font-mono); font-size: 0.75rem; color: #ccc;
            display: flex; flex-direction: column; gap: 4px;
        }
        .log-entry { display: flex; gap: 10px; }
        .log-time { color: #666; min-width: 70px; }
        .log-msg { flex: 1; word-break: break-all; }
        .log-info { color: var(--accent); }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-warn { color: var(--warning); }

        /* --- UI ELEMENTS --- */
        .btn {
            background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px;
            cursor: pointer; font-weight: 600; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }
        
        .prop-row { margin-bottom: 15px; }
        .prop-label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 5px; font-family: var(--font-mono); }
        .prop-input { 
            width: 100%; background: #0f111a; border: 1px solid var(--border); color: var(--text-main);
            padding: 8px; border-radius: 4px; font-family: var(--font-mono); font-size: 0.8rem;
        }

        /* --- CONTEXT MENU --- */
        #ctx-menu {
            position: fixed; display: none; background: var(--panel-bg); border: 1px solid var(--accent);
            box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000; min-width: 180px;
        }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 0.85rem; display: flex; gap: 10px; align-items: center; }
        .ctx-item:hover { background: var(--accent); color: #000; }
        .ctx-sep { height: 1px; background: var(--border); margin: 2px 0; }

        /* --- OVERLAYS --- */
        #search-box {
            position: absolute; top: 15px; left: 15px; background: rgba(26, 29, 41, 0.9);
            border: 1px solid var(--border); padding: 8px; border-radius: 4px; display: flex; gap: 8px;
        }
        #search-input { background: transparent; border: none; color: white; width: 200px; font-family: var(--font-mono); }
    </style>
</head>
<body>

<div id="app-container">
    <!-- Header -->
    <header>
        <div class="brand">
            <i class="fas fa-network-wired"></i> TITAN GRAPH <span style="font-size: 0.7em; opacity: 0.5; border: 1px solid var(--accent); padding: 0 4px; border-radius: 4px;">v4.0</span>
        </div>
        <div class="header-controls">
            <button class="btn btn-secondary" onclick="window.App.undo()"><i class="fas fa-undo"></i></button>
            <button class="btn btn-secondary" onclick="window.App.redo()"><i class="fas fa-redo"></i></button>
            <div style="width: 1px; background: var(--border); margin: 0 5px;"></div>
            <button class="btn btn-secondary" onclick="window.IO.exportJSON()">Export</button>
            <button class="btn" onclick="document.getElementById('file-upload').click()">Import</button>
            <input type="file" id="file-upload" hidden onchange="window.IO.importJSON(this)">
        </div>
    </header>

    <!-- Toolbar -->
    <div id="toolbar">
        <button class="tool-btn active" id="mode-2d" onclick="window.Graph.setMode('2D')" title="2D Mode"><i class="fas fa-circle-nodes"></i></button>
        <button class="tool-btn" id="mode-3d" onclick="window.Graph.setMode('3D')" title="3D Mode"><i class="fas fa-cube"></i></button>
        <div style="width: 20px; height: 1px; background: var(--border);"></div>
        <button class="tool-btn" id="tool-select" onclick="window.Tools.set('select')" title="Select Tool"><i class="fas fa-mouse-pointer"></i></button>
        <button class="tool-btn" id="tool-link" onclick="window.Tools.set('link')" title="Link Tool"><i class="fas fa-link"></i></button>
        <button class="tool-btn" onclick="window.Graph.addNodeManual()" title="Add Node"><i class="fas fa-plus"></i></button>
        <div style="width: 20px; height: 1px; background: var(--border);"></div>
        <button class="tool-btn" onclick="window.Graph.fit()" title="Fit View"><i class="fas fa-compress-arrows-alt"></i></button>
        <button class="tool-btn" onclick="window.Analysis.shortestPath()" title="Shortest Path"><i class="fas fa-route"></i></button>
    </div>

    <!-- Viewport -->
    <div id="viewport">
        <div id="graph-canvas"></div>
        <div id="search-box">
            <i class="fas fa-search" style="color: var(--text-muted); margin-top: 2px;"></i>
            <input type="text" id="search-input" placeholder="Search entities..." oninput="window.Graph.search(this.value)">
        </div>
    </div>

    <!-- Inspector -->
    <div id="inspector">
        <div class="panel-head">Entity Properties</div>
        <div class="panel-body" id="props-content">
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                Select a node to inspect
            </div>
        </div>
    </div>

    <!-- Log Console -->
    <div id="log-panel">
        <div class="log-header">
            <span><i class="fas fa-terminal"></i> SYSTEM LOGS</span>
            <div class="log-controls">
                <button class="log-btn" onclick="window.Logger.copy()"><i class="fas fa-copy"></i> Copy All</button>
                <button class="log-btn" onclick="window.Logger.clear()"><i class="fas fa-trash"></i> Clear</button>
                <button class="log-btn" onclick="window.Logger.toggle()"><i class="fas fa-window-minimize"></i></button>
            </div>
        </div>
        <div id="log-content"></div>
    </div>
</div>

<!-- Context Menu -->
<div id="ctx-menu">
    <div class="ctx-item" onclick="window.Transforms.run('dns')"><i class="fas fa-globe"></i> Resolve DNS (A)</div>
    <div class="ctx-item" onclick="window.Transforms.run('whois')"><i class="fas fa-id-card"></i> WHOIS / RDAP</div>
    <div class="ctx-item" onclick="window.Transforms.run('crt')"><i class="fas fa-certificate"></i> Find Subdomains</div>
    <div class="ctx-item" onclick="window.Transforms.run('geoip')"><i class="fas fa-map-marker-alt"></i> GeoIP Lookup</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" onclick="window.Graph.deleteSelected()"><i class="fas fa-trash" style="color: var(--danger)"></i> Delete Entity</div>
</div>

<script>
/**
 * TITAN GRAPH v4 CORE
 * Namespace: window.App, window.Graph, window.Logger, etc.
 */

// --- LOGGER SYSTEM ---
window.Logger = {
    isMinimized: false,
    
    log(msg, type = 'info') {
        const container = document.getElementById('log-content');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        
        const time = new Date().toLocaleTimeString('en-US', { hour12: false });
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-msg log-${type}">${msg}</span>
        `;
        
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${msg}`);
    },

    toggle() {
        const panel = document.getElementById('log-panel');
        this.isMinimized = !this.isMinimized;
        panel.classList.toggle('minimized', this.isMinimized);
        const icon = panel.querySelector('.fa-window-minimize') || panel.querySelector('.fa-window-maximize');
        if(this.isMinimized) {
            icon.classList.replace('fa-window-minimize', 'fa-window-maximize');
        } else {
            icon.classList.replace('fa-window-maximize', 'fa-window-minimize');
        }
    },

    copy() {
        const text = document.getElementById('log-content').innerText;
        navigator.clipboard.writeText(text).then(() => {
            this.log("Logs copied to clipboard", "success");
        });
    },

    clear() {
        document.getElementById('log-content').innerHTML = '';
        this.log("Log cleared", "info");
    }
};

// --- CONFIG ---
const Config = {
    colors: {
        domain: '#00d2d3', // Cyan
        ip: '#54a0ff',     // Blue
        person: '#feca57', // Yellow
        location: '#ff9ff3', // Pink
        asn: '#5f27cd',    // Purple
        default: '#8395a7' // Grey
    },
    icons: {
        domain: '\uf0ac', ip: '\uf233', person: '\uf007',
        location: '\uf3c5', asn: '\uf19c', default: '\uf128'
    }
};

// --- STORE (STATE) ---
window.Store = {
    state: { nodes: [], links: [] },
    history: [],
    historyIndex: -1,

    init() {
        // Load or Default
        try {
            const saved = localStorage.getItem('titan_v4');
            if (saved) {
                this.state = JSON.parse(saved);
                window.Logger.log("Session restored from local storage", "success");
            } else {
                this.addNode({ label: 'example.com', type: 'domain' });
                window.Logger.log("New session initialized", "info");
            }
        } catch (e) {
            window.Logger.log("Save file corrupted, starting fresh", "error");
            this.addNode({ label: 'example.com', type: 'domain' });
        }
        this.save();
    },

    save() {
        // History Push
        if (this.historyIndex < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyIndex + 1);
        }
        this.history.push(JSON.parse(JSON.stringify(this.state)));
        if (this.history.length > 20) this.history.shift();
        else this.historyIndex++;

        // Persist
        localStorage.setItem('titan_v4', JSON.stringify(this.state));
    },

    undo() {
        if (this.historyIndex > 0) {
            this.historyIndex--;
            this.state = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
            window.Graph.refresh();
            window.Logger.log("Undo action performed", "info");
        }
    },

    redo() {
        if (this.historyIndex < this.history.length - 1) {
            this.historyIndex++;
            this.state = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
            window.Graph.refresh();
            window.Logger.log("Redo action performed", "info");
        }
    },

    addNode(data) {
        // Check duplicate
        const exists = this.state.nodes.find(n => n.label === data.label && n.type === data.type);
        if (exists) return exists;

        const newNode = {
            id: crypto.randomUUID(),
            label: data.label,
            type: data.type || 'default',
            val: 1
        };
        this.state.nodes.push(newNode);
        this.save();
        return newNode;
    },

    addLink(sourceId, targetId) {
        if (sourceId === targetId) return;
        const exists = this.state.links.find(l => 
            (l.source.id === sourceId && l.target.id === targetId) ||
            (l.source === sourceId && l.target === targetId)
        );
        if (!exists) {
            this.state.links.push({ source: sourceId, target: targetId });
            this.save();
        }
    },

    updateNode(id, key, val) {
        const node = this.state.nodes.find(n => n.id === id);
        if (node) {
            node[key] = val;
            this.save();
            window.Graph.refresh();
        }
    },

    deleteNode(id) {
        this.state.nodes = this.state.nodes.filter(n => n.id !== id);
        this.state.links = this.state.links.filter(l => l.source.id !== id && l.target.id !== id && l.source !== id && l.target !== id);
        this.save();
        window.Graph.refresh();
        window.Logger.log(`Deleted node ${id}`, "warn");
    }
};

// --- GRAPH ENGINE ---
window.Graph = {
    instance: null,
    mode: '2D',
    selected: null,

    init() {
        this.render();
        window.addEventListener('resize', () => {
            if (this.instance) {
                const el = document.getElementById('graph-canvas');
                this.instance.width(el.clientWidth).height(el.clientHeight);
            }
        });
        
        // Global Click to close menus
        document.addEventListener('click', () => {
            document.getElementById('ctx-menu').style.display = 'none';
        });
    },

    setMode(newMode) {
        if (this.mode === newMode) return;
        this.mode = newMode;
        
        // UI Update
        document.getElementById('mode-2d').classList.toggle('active', newMode === '2D');
        document.getElementById('mode-3d').classList.toggle('active', newMode === '3D');
        
        window.Logger.log(`Switching to ${newMode} mode`, "info");
        
        // Clean and Re-render
        document.getElementById('graph-canvas').innerHTML = '';
        this.render();
    },

    render() {
        const el = document.getElementById('graph-canvas');
        const w = el.clientWidth;
        const h = el.clientHeight;
        const bg = '#0f111a';

        if (this.mode === '2D') {
            this.instance = ForceGraph()(el)
                .width(w).height(h)
                .backgroundColor(bg)
                .graphData(window.Store.state)
                .nodeLabel('label')
                .nodeColor(n => Config.colors[n.type] || Config.colors.default)
                .linkColor(() => '#2f3542')
                .nodeCanvasObject((node, ctx, globalScale) => {
                    const label = node.label;
                    const fontSize = 12/globalScale;
                    const r = 5;
                    
                    // Highlight
                    if (node === this.selected || node === window.Tools.linkSource) {
                        ctx.beginPath();
                        ctx.arc(node.x, node.y, r * 1.8, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(0, 210, 211, 0.4)';
                        ctx.fill();
                    }

                    // Circle
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, r, 0, 2 * Math.PI);
                    ctx.fillStyle = Config.colors[node.type] || Config.colors.default;
                    ctx.fill();

                    // Icon
                    const icon = Config.icons[node.type] || Config.icons.default;
                    ctx.font = `${4}px "Font Awesome 6 Free"`;
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(icon, node.x, node.y);

                    // Text
                    ctx.font = `${fontSize}px Sans-Serif`;
                    ctx.fillStyle = '#dfe6e9';
                    ctx.fillText(label, node.x, node.y + r + fontSize);
                })
                .onNodeClick(this.onClick.bind(this))
                .onNodeRightClick(this.onRightClick.bind(this))
                .onBackgroundClick(this.deselect.bind(this));
        } else {
            this.instance = ForceGraph3D()(el)
                .width(w).height(h)
                .backgroundColor(bg)
                .graphData(window.Store.state)
                .nodeColor(n => Config.colors[n.type] || Config.colors.default)
                .nodeLabel('label')
                .nodeThreeObject(node => {
                    const sprite = new SpriteText(node.label);
                    sprite.color = node === this.selected ? '#00d2d3' : '#dfe6e9';
                    sprite.textHeight = 8;
                    return sprite;
                })
                .nodeThreeObjectExtend(true)
                .onNodeClick(this.onClick.bind(this))
                .onNodeRightClick(this.onRightClick.bind(this))
                .onBackgroundClick(this.deselect.bind(this));
        }
    },

    refresh() {
        // Force update data reference
        const data = { nodes: [...window.Store.state.nodes], links: [...window.Store.state.links] };
        this.instance.graphData(data);
    },

    onClick(node) {
        if (window.Tools.current === 'link') {
            if (!window.Tools.linkSource) {
                window.Tools.linkSource = node;
                window.Logger.log(`Link Source: ${node.label}. Select target.`, "info");
                this.refresh();
            } else {
                window.Store.addLink(window.Tools.linkSource.id, node.id);
                window.Logger.log(`Linked ${window.Tools.linkSource.label} -> ${node.label}`, "success");
                window.Tools.linkSource = null;
                window.Tools.set('select');
            }
        } else {
            this.selected = node;
            this.showProps(node);
            
            // Fly to
            if (this.mode === '3D') {
                const distRatio = 1 + 50/Math.hypot(node.x, node.y, node.z);
                this.instance.cameraPosition(
                    { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
                    node, 2000
                );
            } else {
                this.instance.centerAt(node.x, node.y, 1000);
                this.instance.zoom(6, 2000);
            }
        }
    },

    onRightClick(node, event) {
        this.selected = node;
        this.showProps(node);
        
        const menu = document.getElementById('ctx-menu');
        let x, y;
        
        // Handle different event structures between 2D/3D libs
        if (event && event.clientX) {
            x = event.clientX; y = event.clientY;
        } else {
            x = window.innerWidth / 2; y = window.innerHeight / 2;
        }

        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.style.display = 'block';
    },

    deselect() {
        this.selected = null;
        window.Tools.linkSource = null;
        document.getElementById('props-content').innerHTML = '<div style="text-align: center; color: var(--text-muted); margin-top: 50px;">Select a node to inspect</div>';
        this.refresh();
    },

    showProps(node) {
        const div = document.getElementById('props-content');
        div.innerHTML = `
            <div class="prop-row">
                <label class="prop-label">LABEL</label>
                <input class="prop-input" value="${node.label}" onchange="window.Store.updateNode('${node.id}', 'label', this.value)">
            </div>
            <div class="prop-row">
                <label class="prop-label">TYPE</label>
                <select class="prop-input" onchange="window.Store.updateNode('${node.id}', 'type', this.value)">
                    ${Object.keys(Config.colors).map(k => `<option value="${k}" ${node.type === k ? 'selected' : ''}>${k.toUpperCase()}</option>`).join('')}
                </select>
            </div>
            <div class="prop-row">
                <label class="prop-label">UUID</label>
                <input class="prop-input" value="${node.id}" disabled style="opacity: 0.5">
            </div>
            <button class="btn" style="background: var(--danger); color: white; width: 100%;" onclick="window.Graph.deleteSelected()">DELETE NODE</button>
        `;
    },

    addNodeManual() {
        const label = prompt("Enter Node Label:");
        if (label) {
            window.Store.addNode({ label, type: 'default' });
            window.Graph.refresh();
            window.Logger.log(`Added node: ${label}`, "success");
        }
    },

    deleteSelected() {
        if (this.selected) {
            window.Store.deleteNode(this.selected.id);
            this.deselect();
        }
    },

    search(query) {
        if (!query) return;
        const node = window.Store.state.nodes.find(n => n.label.toLowerCase().includes(query.toLowerCase()));
        if (node) this.onClick(node);
    },

    fit() {
        this.instance.zoomToFit(500);
    }
};

// --- TOOLS ---
window.Tools = {
    current: 'select',
    linkSource: null,

    set(tool) {
        this.current = tool;
        this.linkSource = null;
        
        document.getElementById('tool-select').classList.toggle('active', tool === 'select');
        document.getElementById('tool-link').classList.toggle('active', tool === 'link');
        
        window.Logger.log(`Tool changed to: ${tool.toUpperCase()}`, "info");
        window.Graph.refresh();
    }
};

// --- TRANSFORMS ---
window.Transforms = {
    proxy: 'https://api.allorigins.win/get?url=',

    async run(type) {
        const node = window.Graph.selected;
        if (!node) return;
        
        document.getElementById('ctx-menu').style.display = 'none';
        window.Logger.log(`Running transform: ${type} on ${node.label}...`, "info");

        try {
            switch(type) {
                case 'dns': await this.dns(node); break;
                case 'whois': await this.whois(node); break;
                case 'crt': await this.crt(node); break;
                case 'geoip': await this.geoip(node); break;
            }
        } catch (e) {
            window.Logger.log(`Transform failed: ${e.message}`, "error");
        }
    },

    async fetch(url) {
        const res = await fetch(this.proxy + encodeURIComponent(url));
        if (!res.ok) throw new Error("Network Error");
        const data = await res.json();
        return data.contents;
    },

    async dns(node) {
        const res = await fetch(`https://dns.google/resolve?name=${node.label}&type=A`);
        const data = await res.json();
        if (data.Answer) {
            let count = 0;
            data.Answer.forEach(r => {
                if (r.type === 1) {
                    const ip = window.Store.addNode({ label: r.data, type: 'ip' });
                    window.Store.addLink(node.id, ip.id);
                    count++;
                }
            });
            window.Graph.refresh();
            window.Logger.log(`Resolved ${count} IP addresses`, "success");
        } else {
            window.Logger.log("No DNS records found", "warn");
        }
    },

    async crt(node) {
        try {
            const raw = await this.fetch(`https://crt.sh/?q=%.${node.label}&output=json`);
            const data = JSON.parse(raw);
            const unique = [...new Set(data.map(d => d.name_value))].slice(0, 8);
            
            unique.forEach(sub => {
                const n = window.Store.addNode({ label: sub, type: 'domain' });
                window.Store.addLink(node.id, n.id);
            });
            window.Graph.refresh();
            window.Logger.log(`Found ${unique.length} subdomains`, "success");
        } catch (e) {
            throw new Error("Certificate search failed");
        }
    },

    async geoip(node) {
        // Check if IP
        if (!/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(node.label)) throw new Error("Target is not an IP");
        
        const raw = await this.fetch(`https://ipapi.co/${node.label}/json/`);
        const data = JSON.parse(raw);
        
        if (data.city) {
            const loc = window.Store.addNode({ label: `${data.city}, ${data.country_code}`, type: 'location' });
            window.Store.addLink(node.id, loc.id);
            
            if (data.org) {
                const asn = window.Store.addNode({ label: data.org, type: 'asn' });
                window.Store.addLink(node.id, asn.id);
            }
            window.Graph.refresh();
            window.Logger.log("GeoIP data enriched", "success");
        }
    },

    async whois(node) {
        const isIp = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(node.label);
        const url = isIp ? `https://rdap.arin.net/registry/ip/${node.label}` : `https://rdap.org/domain/${node.label}`;
        
        try {
            const raw = await this.fetch(url);
            const data = JSON.parse(raw);
            
            if (data.entities) {
                let count = 0;
                data.entities.forEach(e => {
                    const name = e.vcardArray?.[1]?.find(x => x[0] === 'fn')?.[3] || e.handle;
                    if (name) {
                        const n = window.Store.addNode({ label: name, type: 'person' });
                        window.Store.addLink(node.id, n.id);
                        count++;
                    }
                });
                window.Graph.refresh();
                window.Logger.log(`Found ${count} WHOIS entities`, "success");
            }
        } catch (e) {
            throw new Error("RDAP/WHOIS lookup failed");
        }
    }
};

// --- ANALYSIS ---
window.Analysis = {
    shortestPath() {
        const start = window.Graph.selected;
        if (!start) { window.Logger.log("Select a start node first", "warn"); return; }
        
        const targetLabel = prompt("Enter target node label:");
        const target = window.Store.state.nodes.find(n => n.label === targetLabel);
        
        if (!target) { window.Logger.log("Target node not found", "error"); return; }

        // BFS
        const queue = [[start.id]];
        const visited = new Set([start.id]);
        
        while (queue.length > 0) {
            const path = queue.shift();
            const id = path[path.length - 1];
            
            if (id === target.id) {
                window.Logger.log(`Path found: ${path.length - 1} hops`, "success");
                // Highlight logic could go here
                return;
            }
            
            const neighbors = window.Store.state.links
                .filter(l => l.source.id === id || l.target.id === id)
                .map(l => l.source.id === id ? l.target.id : l.source.id);
                
            for (const n of neighbors) {
                if (!visited.has(n)) {
                    visited.add(n);
                    queue.push([...path, n]);
                }
            }
        }
        window.Logger.log("No path found", "warn");
    }
};

// --- IO ---
window.IO = {
    exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.Store.state));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `titan_graph_${Date.now()}.json`;
        a.click();
        window.Logger.log("Graph exported to JSON", "success");
    },

    importJSON(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                window.Store.state = json;
                window.Store.save();
                window.Graph.refresh();
                window.Logger.log("Graph imported successfully", "success");
            } catch (err) {
                window.Logger.log("Import failed: Invalid JSON", "error");
            }
        };
        reader.readAsText(file);
    },
    
    undo: () => window.Store.undo(),
    redo: () => window.Store.redo()
};

// --- APP FACADE ---
window.App = {
    undo: () => window.Store.undo(),
    redo: () => window.Store.redo()
};

// --- INIT ---
window.onload = () => {
    window.Store.init();
    window.Graph.init();
    window.Logger.log("System Online. Ready for analysis.", "success");
};

</script>
</body>
</html>
